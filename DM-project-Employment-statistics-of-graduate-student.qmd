---
title: "DMC Project: Employment statistics of graduate students"
author: "Lou Delattre and Yufeng Jiang"
format: 
  html: default 
  wordcount-pdf:
    indent: true
    first-line-indent:
      size: 1.5em
    tbl-cap-location: bottom
execute: 
  echo: false
  warning: false
---

```{r}
here::i_am("DM-project-Employment-statistics-of-graduate-student.Rproj")
library(here)
library(vroom)
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)
library(knitr)
library(broom)
library(fastDummies)
library(kableExtra)
theme_set(theme_bw())
```

Github repository: 
<https://github.com/Mapleyf0911/DM-project-Employment-statistics-of-graduate-student.git>

## Goal of our research

We will define the goals of our quantitative analysis. Data on the insertion rate and different measures of wages allow us to compute and make comparisons between sectors, and to emit hypotheses on correlations between some of our variables at various levels. Expressing these hypotheses, we obtain the following questions:

-   Which fields/specializations lead to the highest wages, have the highest insertion rate, or have the highest level of stable employment? This will be the focus of our analysis. We can compute the mean wage/rate for each field and make comparisons.

-   Is the university that one goes to a significant factor to explain wages? We could take one field/specialization taught at different universities, focus on these observations to make a (simple) regression, and try to determine the significance of the "university" factor.

-   How do the wages of these graduates compare to the average national/regional salaries? How do they compare to the average of their respective fields? Using the results of the first question and data from the additional data set, various plot representations could be meaningful.

-   Are there significant differences between observations made 18 months after graduating and observations made 30 months after graduating? It will be necessary to separate the programs where we have 18-month observations, those with 30-month observations, and those with both, and isolate this last category.

-   Do some specializations require to leave the region of the "académie" where the master's degree was done? It could show the concentration of certain industries at national level.

-   Do some specializations attract more women/scholarship students? There are already studies on the type of profile each field is more likely to attract, thus we can try to find the same results with our data set.

We do not have a unique research question, as it would not allow us to do enough testing at our level, given our data set. However, all of the above-mentioned questions go in the same direction: what can be inferred from our data sets about the situation of graduate students? This will certainly be insufficient to make any real conclusions, nonetheless this may help define guidelines for a bigger project.

## The data sets

### Data import

We aim to analyze the employability, situation of employment and salary of graduate students, depending on their graduate program, university and "académie".

Here, we are using employment statistics from the professional insertion survey of Master students made by the Ministère de l'Enseignement Supérieur et de la Recherche. The survey focus on French graduate students who have completed their initial training ("formation initiale" in French) and have not continued or resumed their studies in the two years following their graduation. The survey shows the employment status at two key time points: 18 months and 30 months after their graduation.

#### Main data set

```{r}
insertion_master <- vroom(here("data", "fr-esr-insertion_professionnelle-master-national.csv"))
```

|                        |                            |
|------------------------|----------------------------|
| Number of observations | `r NROW(insertion_master)` |
| Number of variables    | `r NCOL(insertion_master)` |

**Source:** <https://data.enseignementsup-recherche.gouv.fr/explore/embed/dataset/fr-esr-insertion_professionnelle-master/table/?disjunctive.academie&disjunctive.numero_de_l_etablissement&sort=-annee>

In this data set, each observation includes:

-   The year of the survey, the type of master's degree, the university number and the "académie" number and name;

-   The name of the university responsible of the degree, the field ("domaine") and subject ("discipline") of the graduate program;<br>

-   The number of responses and response rate;<br>

-   The percentage of women and scholarship students; <br>

-   The "insertion" rate (% of the graduates that are employed);<br>

-   The percentage of students that work full-time, in executive positions, and outside the region of their university;<br>

-   The median monthly net salary and the estimated gross annual salary of graduates that work full time;<br>

-   The regional unemployment rate; <br>

-   First and third quartiles regional net monthly salaries. <br>

#### Complementary data set

For comparison purposes, we found wage data in a report titled "Île-de-France accounts for half of the highest-paid private sector employees in France" of Insee. The data used for this report was collected by the Insee from two databases (Tous Salariés and Flores).<br>

The database Tous Salariés has all the information about employees. They use the administrative declaration submitted by employers. In the private sector, the annual salary salaries and the number of employees data are mainly derived from Nominative Social Declarations ("Déclarations sociales nominatives (DSN)" in French) and Annual Social Data Declaration ("Déclarations annuelles des données sociales (DADS)" in French). Employees in the agricultural sector, employees of private households, apprentices, and interns are excluded from this study.

The database (Flores 2018) covers all employers (civil service, private employers, including individual employers), with the exception of the employment activities of the Ministry of Armed Forces (France). This database can be used to describe salaried employment across all sectors.

From the data set, we have 2018 data on median/average salaries in the Île-de-France region and at national level, taking into account multiple variables such as sector, type of position and gender. We estimate there are enough sectors included in the file to classify all graduate programs.

Source: <https://www.insee.fr/fr/statistiques/5650198>

This data is presented in several tables. We simply split the file by each table and removed some textual explanatory information before importing the needed table into R.

We have:

-   the different deciles of net wages at the Île-de-France and national levels;

```{r}
Net_wage_EQTP <- vroom(here("data", "Figure_1_Distribution_of_Monthly_Net_Wages_in_Ile-de-France_and_France_EQTP.csv"))
```

-   the percentage of different types of earners in the Île-de-France regions;

```{r}
pct_high_income <- vroom(here("data", "Figure_2_Ile-de-France_Share_in_High_Incomes_High_Wealth_and_High_Wages.csv"))
```

-   the average net wages of each gender in different employment categories;

```{r}
wages_profession_gender <- vroom(here("data", "Figure_4_Average_Monthly_Net_Wages_EQTP_by_Socio-Professional_Category_and_Gender.csv"))
```

#### Data set joining

Here, we get the panel data "insertion_master_panel" by joining the wage data from the complementary data set to our main data set "insertion_master_panel".

```{r}
#'[That chunk should only be executed once.]
Net_wage_EQTP$`ile-de-France` <- Net_wage_EQTP$`ile-de-France`*1000
Net_wage_EQTP$France <- Net_wage_EQTP$France*1000
```

```{r}
Net_wage_EQTP_wide_regional_national <- Net_wage_EQTP |>
    pivot_wider(names_from = ...1, values_from = c(`ile-de-France`, France), 
              names_sep = " ") 
##
rows_to_fill <- nrow(insertion_master) - nrow(Net_wage_EQTP_wide_regional_national)
##
if (rows_to_fill > 0) {
  repeated_data <- map(1:rows_to_fill, ~ Net_wage_EQTP_wide_regional_national) |>
    bind_rows()
  Net_wage_EQTP_wide_regional_national <- bind_rows(Net_wage_EQTP_wide_regional_national, repeated_data)
}
#'[Joining of data sets]
insertion_master_panel <- cbind(insertion_master, Net_wage_EQTP_wide_regional_national)

```

### Data cleaning

In our main data set, there are 35 variables. Some of them might be superfluous or at least not relevant for our analysis.

-   "Etablissement actuel" (the 5th column) just gives the exact full name of the university, but in reality we know the corresponding university from the abbreviation.

-   "cle_ETAB" (the 33th column) could be obtained using more explicit columns.

-   "Id_Paysage" (the 35th column) has the same purpose as "Code de l'établissement".

-   "Taux d'emploi" (the 18th column) and "Taux d'emploi en France" (the 19th column) are missing a significant amount of values (17669 out of 19603 observations). We consider that "Taux d'insertion" is sufficient, as the difference between the employment rate and insertion rate may not be significant. According to the original source, the employment rate is computed including "inactives" (neither working nor in search of employment.) while the insertion rate does not include them.

Therefore, we can delete the 5th, 18th, 19th, 33th and 35th columns in the original data set.

```{r}
insertion_master_panel <- insertion_master_panel |> select(-c(5, 18, 19, 33, 35))
```

However, some graduate programs have two observations (one after 18 months, one after 30 months). To perfectly identify each observation of each master program, we have to create another variable (or primary key).

-   The identifier is called "obs_ID" and is made of the concatenation of "Année", "Numéro de l'établissement" and "cle_disc".

```{r}
## création clé 
insertion_master_panel <- insertion_master_panel |>
  mutate(obs_ID = paste(Annee,  `Numéro de l'établissement`, `cle_DISC`, sep = "_"))
```

In the "Remarque" column, there are five possible values:

1.  Université ayant participé à l'enquête mais dont l'effectif est trop petit pour que les résultats soient jugés exploitables; \[Inadequate Size of Graduates Population\]
2.  Université ayant participé à l'enquête mais dont le taux de réponse obtenu est insuffisant pour que les résultats soient jugés exploitables; \[insufficient response rate\]
3.  Université dont les résultats sont plus fragiles (taux de réponse inférieur à 50%); \[weak results\]
4.  Université n'ayant pas participé à l'enquête; \[non-participating\]
5.  N/A \[no comment\].

Among all observations, only those where the "Remarque" is either "Université dont les résultats sont plus fragiles (taux de réponse inférieur à 50%)" or "N/A" contain the necessary data for further analysis (e.g., graduate employment rates and salary levels). Therefore, we will retain only those observations that meet these two conditions.

Some of the observations are on aggreagate data from all degrees of the same discipline, by year. As they are on national data, they are not related to any specific "académie". We will keep them for analysis purposes but after removing them from the main data set.

```{r}
## removing 
insertion_master_panel <- insertion_master_panel |> 
  filter(is.na(Remarque)| Remarque == "Université dont les résultats sont plus fragiles (taux de réponse inférieur à 50%)" )

## isolating aggregate observations 
aggregate_data <- insertion_master_panel |> 
  filter(is.na(Académie))

## removing aggregate observations from main data set 
insertion_master_panel <- insertion_master_panel |> filter(!is.na(Académie))


```

In the data set "insertion_master_panel", many values are missing, due to absence of data ("nd" = non disponible) or unusable data ("ns" = "non significatif" and "fe" = "faible effectif"). Here, we examine how many missing values we have in each column, and address these missing values carefully before our analysis.

```{r}
selected_columns <- insertion_master_panel[, 13:29]

is_non_numeric <- function(x) {
  as.character(x) == "ns" | as.character(x) == "nd" | as.character(x) == "fe" | as.character(x) == "." | is.na(x)
}
non_numeric_counts <- sapply(selected_columns, function(column){
  sum(is_non_numeric(column))
})
  
kable(data.frame(non_numeric_counts))

```

```{r}
insertion_master_panel[] <- lapply(insertion_master_panel, function(x) ifelse(x == "ns", NA, x))
insertion_master_panel[] <- lapply(insertion_master_panel, function(x) ifelse(x == "nd", NA, x))
insertion_master_panel[] <- lapply(insertion_master_panel, function(x) ifelse(x == "fe", NA, x))
insertion_master_panel[] <- lapply(insertion_master_panel, function(x) ifelse(x == ".", NA, x))
```

To facilitate our future analysis, we convert some character-formatted data values into numeric format.

```{r}
cols_to_convert <- c(16:21, 23:29)
insertion_master_panel[, cols_to_convert] <- sapply(insertion_master_panel[, cols_to_convert], function(x){
  if (is.character(x)){
    as.numeric(ifelse(is.na(x), NA, x))
  } else {
    x
  }
})
```

## Data analysis

After the data cleaning, we have the following summary of our data set:

|          Categories           |                             Number                              |
|:-----------------------:|:--------------------------------------------:|
|           Académies           |   `r insertion_master_panel |> distinct(Académie) |> nrow()`    |
| Etablissements (universities) | `r insertion_master_panel |> distinct(Établissement) |> nrow()` |
|       Domaines (fields)       |    `r insertion_master_panel |> distinct(Domaine) |> nrow()`    |
| Disciplines (specializations) |  `r insertion_master_panel |> distinct(Discipline) |> nrow()`   |

### Q1: Which fields/specializations lead to the highest wages, have the highest insertion rate, or have the highest level of stable employment?

```{r}
best_specializations_max <- insertion_master_panel |>
  group_by(Domaine, Discipline) |>
  summarise(
    MaxSalaire = ifelse(all(is.na(`Salaire brut annuel estimé`)), NA_real_, max(`Salaire brut annuel estimé`, na.rm = TRUE)),
    MaxInsertionRate = ifelse(all(is.na(`Taux d’insertion`)), NA_real_, max(`Taux d’insertion`, na.rm = TRUE)),
    MaxStableEmployment = ifelse(all(is.na(`% emplois stables`)), NA_real_, max(`% emplois stables`, na.rm = TRUE)),
    .groups = "drop"
  ) |>
  arrange(Domaine, desc(MaxSalaire), desc(MaxInsertionRate), desc(MaxStableEmployment))
```

For this question, we tried to find the "best fields/specializations" from two perspectives. We first conducted a preliminary analysis with the optimal level of employment performance in each fields ("Domaine" column). In terms of insertion rate and stable employment rate, the employment performance of graduates from arts, literature and languages fields are the worst, with both rates below 100%, while all other disciplines achieved a 100% employment rate. From the perspective of salary levels, graduates from Law, Economics and Management fields as well as Science, Technology, and Health fields get the highest pay, reaching €49,100. Graduates from arts, literature, and languages fields still performed the worst, with a salary of only €34,300.

```{r}
max_salary_domain <- best_specializations_max |>
  group_by(Domaine) |>
  summarise(MaxSalaire = max(MaxSalaire, na.rm = TRUE)) |>
  arrange(desc(MaxSalaire))

max_insertion_rate_domain <- best_specializations_max |>
  group_by(Domaine) |>
  summarise(MaxInsertionRate = max(MaxInsertionRate, na.rm = TRUE)) |>
  arrange(desc(MaxInsertionRate))

max_stable_employment_domain <- best_specializations_max |>
  group_by(Domaine) |>
  summarise(MaxStableEmployment = max(MaxStableEmployment, na.rm = TRUE)) |>
  arrange(desc(MaxStableEmployment))

merged_domain_stats <- max_salary_domain |>
  left_join(max_insertion_rate_domain, by = "Domaine") |>
  left_join(max_stable_employment_domain, by = "Domaine")

kable(merged_domain_stats, caption = "Optimal Employment Perfomance by Domain")
```

Further, we looked at the average performance of employment in each domain/specialization. We could get the similar conclusion. Graduates from **Sciences, technologies et santé** and **Droit, économie et gestion** fields stand out in terms of average salaries, earning €31,468 and €31,350 respectively, ranking first and second. In contrast, graduates from **Lettres, langues, arts** have the lowest average salary.

Regarding the insertion rate, three fields exceed 90%: **Sciences, technologies et santé**, **Droit, économie et gestion**, and **Masters enseignement**. Among them, **Masters enseignement** excels not only in employment rate but also in stable employment rate, outperforming all other fields in the latter.

Another interesting fact we found is that the average salary for **Masters enseignement** graduates is not as high as in certain other fields, their good performance in both successful employment and employment stability makes it a compelling choice for prospective students.

```{r}
best_domain_mean <- insertion_master_panel |>
  group_by(Domaine) |>
  summarise(
    MeanSalaire = ifelse(all(is.na(`Salaire brut annuel estimé`)), NA_real_, mean(`Salaire brut annuel estimé`, na.rm = TRUE)),
    MeanInsertionRate = ifelse(all(is.na(`Taux d’insertion`)), NA_real_, mean(`Taux d’insertion`, na.rm = TRUE)),
    MeanStableEmployment = ifelse(all(is.na(`% emplois stables`)), NA_real_, mean(`% emplois stables`, na.rm = TRUE)),
    .groups = "drop"
  ) |>
  arrange(desc(MeanSalaire))

kable(best_domain_mean, caption = "Average Employment Perfomance by Domain")

best_domain_long <- best_domain_mean |>
  pivot_longer(
    cols = c(MeanSalaire, MeanInsertionRate, MeanStableEmployment),
    names_to = "Metric",
    values_to = "Value"
  )

best_domain_long <- best_domain_long |>
  mutate(Metric = factor(Metric, levels = c("MeanSalaire", "MeanInsertionRate", "MeanStableEmployment")))
```

```{r}
#| fig-width: 10
#| fig-height: 6

ggplot(best_domain_long, aes(x = Domaine, y = Value, fill = Domaine)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.8) +
  facet_wrap(~ Metric, scales = "free_y") +
  labs(title = "Average Employment Perfomance by Domain",
       x = "Domaine",
       y = "Value",
       fill = "Domaine") +
  theme_minimal() +
  theme(
    legend.position = "right", 
    legend.text = element_text(size = 8), 
    axis.text.x = element_blank(), 
    axis.ticks.x = element_blank(), 
    plot.margin = unit(c(1, 1, 1, 1), "cm") ,
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5)
  ) +
  scale_fill_brewer(palette = "Set2") +
  scale_x_discrete(limits = c("Sciences, technologies et santé", "Droit, économie et gestion", "Masters enseignement", "Sciences humaines et sociales", "Lettres, langues, arts")) 

```

```{r}
best_specializations_mean <- insertion_master_panel |>
  group_by(Discipline, Domaine) |>
  summarise(
    MeanSalaire = ifelse(all(is.na(`Salaire brut annuel estimé`)), NA_real_, mean(`Salaire brut annuel estimé`, na.rm = TRUE)),
    MeanInsertionRate = ifelse(all(is.na(`Taux d’insertion`)), NA_real_, mean(`Taux d’insertion`, na.rm = TRUE)),
    MeanStableEmployment = ifelse(all(is.na(`% emplois stables`)), NA_real_, mean(`% emplois stables`, na.rm = TRUE)),
    .groups = "drop"
  ) |>
  arrange(desc(MeanSalaire))
```

```{r}
# Using aggregate data
# Convert the character-formatted data values into numeric format
cols_to_convert <- c(16:21, 23:29)
aggregate_data[, cols_to_convert] <- sapply(aggregate_data[, cols_to_convert], function(x){
  if (is.character(x)){
    as.numeric(ifelse(is.na(x), NA, x))
  } else {
    x
  }
})

years_of_interest <- aggregate_data |>
  select(Annee) |>
  distinct()

create_summary_table <- function(year) {
  aggregate_data |>
    filter(Annee == year) |>
    group_by(Domaine) |>
    summarise(
      MeanSalaire = round(mean(`Salaire brut annuel estimé`), 2),
      MeanInsertionRate = round(mean(`Taux d’insertion`, na.rm = TRUE), 2),
      MeanStableEmployment = round(mean(`% emplois stables`, na.rm = TRUE), 2),
      .groups = "drop"
    ) |>
    arrange(desc(MeanSalaire))
}

summary_tables <- lapply(years_of_interest$Annee, create_summary_table)

# Show result by year 
# Slight difference: in some years, graduates form "Droit, économie et gestion" received the highest pay, but "Sciences, technologies et santé" and "Droit, économie et gestion" always ranked 1st and 2nd among all fields )
for (i in seq_along(summary_tables)) {
  cat("Summary table for year", years_of_interest$Annee[i], ":\n")
  print(summary_tables[[i]])
  cat("\n")
}


# Show result ()
aggregate_mean <- aggregate_data |>
  group_by(Domaine) |>
  summarise(
    MeanSalaire = round(mean(`Salaire brut annuel estimé`, na.rm = TRUE), 2),
    MeanInsertionRate = round(mean(`Taux d’insertion`, na.rm = TRUE), 2),
    MeanStableEmployment = round(mean(`% emplois stables`, na.rm = TRUE), 2),
    .groups = "drop"
  ) |>
  arrange(desc(MeanSalaire))

kable(merged_domain_stats, caption = "Optimal Employment Perfomance by Domain")
```

### Q2: Is the university that one goes to a significant factor to explain wages?

To explore this question, let's first have a look at the summary of the salary data for economics graduates from different universities. Here, we use the data collected 30 months after graduation.

```{r}
reg_econ <- insertion_master_panel |> 
  filter(`Code de la discipline` == "disc03" & situation == "30 mois après le diplôme" & !is.na(`Salaire net médian des emplois à temps plein`))  |> 
  group_by(Établissement) |>
  summarise("Salaire moyen entre 2010 et 2021" = mean(`Salaire net médian des emplois à temps plein`)) |>
  arrange(desc(`Salaire moyen entre 2010 et 2021`))

top_5 <- reg_econ[1:5, ]
bottom_5 <- reg_econ[(nrow(reg_econ)-4):nrow(reg_econ),]

top_5 <- top_5 |>
  bind_rows(data.frame(`Établissement` = "..."))

merged_table <- top_5 |>
  bind_rows(bottom_5)

merged_table$`Salaire moyen entre 2010 et 2021` <- sapply(merged_table$`Salaire moyen entre 2010 et 2021`, function(x) {
  if (is.na(x)) {
    return(NA) # If the value is NA, keep it as NA
  } else {
    return(format(x, digits = 2, nsmall = 2))  # Keep two decimal places
  }
})

merged_table[is.na(merged_table)] <- "..."

kable(merged_table, align = "c", caption = "Average Salaries of Economics Graduates 30 Months Post-Graduation")
```

From the table above, we can easily find that there are significant differences in salary levels among economics graduates from different universities. Graduates from Paris-Panthéon-Assas got an average monthly salary of €2,920, while those from Perpignan - Via Domitia earned just over half of that amount. However, this is just a rough analysis; there are many other factors that influence the salary levels of graduates in the same field, such as the choice of employment location after graduation and the number of months since graduation. For most sectors, the average salary in the region where graduates work has a substantial impact on their income. Therefore, we try to control the effect of other factors when we do the further analysis in the next part.

From the graphs below, we can notice an evident increase in salaries between the two time frames (18 months and 30 months after graduation). Comparing the two panels in each figure, the distribution of points in the right-hand side plots (30 months) shows an overall upward shift, which indicates a larger number of graduates achieving better salaries and a reduction in the number of graduates in lower salary ranges.

However, the university factor does not appear to have a significant impact on determining graduate salary levels. In contrast, from both sets of graphs, we can find that graduates from the Sciences, technologies et santé and Droit, économie et gestion fields consistently achieve higher average salaries. Meanwhile, graduates from Sciences humaines et sociales and Lettres, langues, arts fields consistently have lower average salaries, which corresponds to our findings before.

```{r}
#| fig-width: 11
#| fig-height: 5

insertion_master_IDF <- insertion_master_panel |> 
  filter(Académie == "Paris")

insertion_master_IDF <- insertion_master_IDF |> 
  mutate(Domaine = factor(Domaine, levels = c(
    "Sciences, technologies et santé",
    "Droit, économie et gestion",
    "Masters enseignement",
    "Sciences humaines et sociales",
    "Lettres, langues, arts"
  )))

ggplot(insertion_master_IDF, aes(x = Établissement, y = `Salaire brut annuel estimé`, color=Domaine)) +
  geom_point(alpha = 0.3) +
  theme(
    axis.text.x = element_blank(),  
  ) +
  facet_wrap(vars(situation)) +
  labs(
    title = "Estimated Average Annual Salaries of Graduates from Different Universities in Paris",
    x = "University",
    y = "Estimated Average Annual Salary (€)"
  )
```

```{r}
#| fig-width: 11
#| fig-height: 5

insertion_master_hors_IDF <- insertion_master_panel |> 
  filter(Académie != "Paris")

insertion_master_hors_IDF <- insertion_master_hors_IDF |> 
  mutate(Domaine = factor(Domaine, levels = c(
    "Sciences, technologies et santé",
    "Droit, économie et gestion",
    "Masters enseignement",
    "Sciences humaines et sociales",
    "Lettres, langues, arts"
  )))


ggplot(insertion_master_hors_IDF, aes(x = Établissement, y = `Salaire brut annuel estimé`, color=Domaine)) +
  geom_point(alpha = 0.3) +
  theme(
    axis.text.x = element_blank(),  
  ) +
  facet_wrap(vars(situation))+
  labs(
    title = "Estimated Average Annual Salaries of Graduates from Different Universities outside IDF",
    x = "University",
    y = "Estimated Average Annual Salary (€)"
  )
```

**Regression model**

To analyze the effect of universities on graduate salaries while controlling the effect of other variables, we can construct the following regression model:

$$
Y_i = \beta_0 + \sum_{j=1}^{J-1} \beta_j D_{University_j} + \sum_{k=1}^{K-1} \gamma_k D_{Field_k} + \sum_{l=1}^{L-1} \delta_l D_{Situation_l} + \phi \cdot RegionalSalary + \epsilon_i
$$ Where:<br> - $Y_i$: Estimated annual salaries.<br> - $D_{University_j}$: Dummy variables for universities.<br> - $D_{Field_k}$: Dummy variables for fields.<br> - $D_{Situation_l}$: Dummy variables for situation (18 or 30 months since graduation).<br> - $RegionalSalary$: Regional median net monthly salary.<br>

```{r}
# Data Preparation for regression
insertion_master_reg <- insertion_master_panel[, c(1, 4, 6, 8, 11, 20:22, 24)]
ref_group <- aggregate_data[, c(1, 4, 6, 8, 11, 20:22, 24)]

cols_to_convert <- c(6, 7, 9)
ref_group[, cols_to_convert] <- sapply(ref_group[, cols_to_convert], function(x){
  if (is.character(x)){
    as.numeric(ifelse(is.na(x), NA, x))
  } else {
    x
  }
})

insertion_master_reg <- insertion_master_reg |>
  bind_rows(ref_group)
```

```{r}
insertion_master_reg$Académie <-
  as.character(insertion_master_reg$Académie)

insertion_master_reg[is.na(insertion_master_reg[, 3]), 3] <- "Toutes université"
```

We need to set a reference group for each categorical variable when creating dummy variables. For the variable "Établissement," we select "Toutes universités et établissements assimilés" as the reference group. This choice allows us to compare the performance of individual universities against the average performance of all universities in our dataset. For the variable "Domaine," we choose "Masters enseignement" as the reference group because graduates from this field typically exhibit employment outcomes that are average compared to the other five fields. This choice will enable us to assess the employment performance differences between graduates from "Masters enseignement" and those from the other four fields. And for the variable "situation," which has only two possible values, either value can serve as the reference group.

**Interpretation of Regression Results**

Based on the regression results (as detailed in Appendix 1), the set of dummy variables for *university* ($D_{University}$) demonstrates weak explanatory power for graduates' salary levels ($Y_i$). Only a small number of universities exhibit statistically significant positive or negative correlation with response Variable ($Y_i$) at the 1% significance level. However, for the majority of universities, the coefficients are not statistically significant, suggesting that the single factor *university* is not sufficient to explain the salary disparities among graduates.

In contrast, other variables, such as field of study ($D_{Field}$), the number of months since graduation\* ($D_{Situation}$), and regional salary levels ($\text{RegionalSalary}$), display stronger statistical significance and higher explanatory power in the regression results. This aligns well with well-established economic theories, which emphasize that factors like academic discipline, regional labor market characteristics, and the timing of graduates' entry into the workforce have more direct and significant effects on salary levels.

```{r}
insertion_master_reg$Établissement <- factor(insertion_master_reg$Établissement)
insertion_master_reg$Domaine <- factor(insertion_master_reg$Domaine)
insertion_master_reg$Académie <- factor(insertion_master_reg$Académie)
insertion_master_reg$situation <- factor(insertion_master_reg$situation)


insertion_master_reg$Établissement <- relevel(insertion_master_reg$Établissement, ref = "Toutes universités et établissements assimilés")
insertion_master_reg$Domaine <- relevel(insertion_master_reg$Domaine, ref = "Masters enseignement") 
insertion_master_reg$situation <- relevel(insertion_master_reg$situation, ref = "18 mois après le diplôme") 


regression_uni <- lm(`Salaire brut annuel estimé` ~ Établissement + Domaine + situation + `Salaire net mensuel médian régional`, data = insertion_master_reg)

reg_result_table <- tidy(regression_uni)
reg_result_table$Significance <- symnum(reg_result_table$`p.value`,
                                          cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
                                          symbols = c("***", "**", "*", ".", " "))
```

```{r}
reg_result_table$Category <- ifelse(grepl("^Établissement", reg_result_table$term), "University",
                                   ifelse(grepl("^Domaine", reg_result_table$term), "Field",
                                          ifelse(grepl("^situation", reg_result_table$term), "Situation",
                                                 ifelse(reg_result_table$term == "(Intercept)", "Intercept",
                                                        "RegionalSalary"))))


reg_result_summary <- reg_result_table |>
  mutate(across(where(is.numeric), ~round(., 3))) |>
  select(!Category) |>
  filter(Significance == "***") 
  
kable(reg_result_summary, caption = "Regression Coefficients Table (Part.)")


```

**MAYBE DELETE THE FOLLOWING PART OF Q2**

Here, to control the effect of regional salary on the annual salary graduates obtained, we decide to do the regression by different groups of "Académie". However, since in some Académies, there is only one university, it will be impossible to run regression model if we do not remove those Académies. Fortunately, the number of these kind of Académies is small. Removing them out of our dataset would not have a huge impact on our final result.

```{r}
academie_groups <- split(insertion_master_reg, insertion_master_reg$Académie)
lapply(academie_groups, function(insertion_master_reg) {
  sapply(insertion_master_reg[, c("Établissement", "Domaine", "situation")], function(var) {
    length(unique(var))
  })
})
```

```{r}
valid_columns <- sapply(insertion_master_reg[, c("Établissement", "Domaine", "situation")], function(var) {
    length(unique(var)) > 1
  })

```

```{r}
#'[Temporairement désactivé pour pouvoir créer le pdf]
##regression_uni_by_group <- lapply(academie_groups, function(insertion_master_reg){
##  regression_uni <- lm(`Salaire brut annuel estimé` ~ Établissement + Domaine + ##situation + `% de diplômés boursiers`, data = insertion_master_reg)
##  return(regression_uni)
##})

```

### Q3: How do the wages of these graduates compare to the average national/regional salaries? How do they compare to the average of their respective fields?

```{r}
nat_net_avg <- round(mean(insertion_master_panel$`Salaire net médian des emplois à temps plein`, na.rm = TRUE), 3)
```

The national net monthly average wage is `r wages_profession_gender[10,5]*1000` €, while the net monthly average wage of the surveyed students is `r paste(nat_net_avg)` €. We have to keep in mind that the people surveyed are at the very beginning of the professional careers and probably employed in entry-level jobs. A lower average wage is thus to be expected. This skews any analysis we could make with the complementary data set as it is not conditional on years of professional experience. Also, the specializations of the various graduate degrees are still too vague to be able to classify them in the different categories of any figure of the complementary data set.

### Q4: Are there significant differences between observations made 18 months after graduating and observations made 30 months after graduating?

We compute the average insertion rate for the observations collected 18 months post-graduation and those collected 30 months post-graduation, as well as their respective standard deviation.

```{r}
insertion_master_panel |>
  group_by(situation) |>
  summarize(`Mean insertion rate` = mean(`Taux d’insertion`, na.rm = TRUE),
            `σ insertion rate` = sd(`Taux d’insertion`, na.rm = TRUE) ) |>
  knitr::kable(digits = 3, align = "c")

mean_insertion <- round(mean(insertion_master_panel$`Taux d’insertion`, na.rm = TRUE), 2)
```

Overall, the average insertion rate is `r paste(mean_insertion)` % . The moment of collection does not seem to be relevant.

### Q5: Do some specializations require to leave the region of the “académie” where the master’s degree was done?

We try to look at the percentage of graduates working outside of their region of graduation for all "académies", depending on the specialization. The two tables below show the specializations with the highest and lowest rates of graduates leaving for each "académie".

```{r}
## The columns '% emplois extérieurs à la région de l'université', '% femmes' and '% de diplômés boursiers' have to be converted into numerical values for Q5 and Q6. 
aggregate_data[, c(22, 26, 27)] <- sapply(aggregate_data[, c(22, 26, 27)], function(x){
  if (is.character(x)){
    as.numeric(ifelse(is.na(x), NA, x))
  } else {
    x
  }
})

```

```{r}
insertion_master_panel[, c(26, 27)] <- sapply(insertion_master_panel[, c(26, 27)], function(x){
  if (is.character(x)){
    as.numeric(ifelse(is.na(x), NA, x))
  } else {
    x
  }
})

insertion_master_panel |>
  filter(!is.na(`% emplois extérieurs à la région de l’université`)) |>
  group_by(Académie,Domaine) |>
  summarise(`%_ext` = mean(`% emplois extérieurs à la région de l’université`))|>
  slice(which.max(`%_ext`)) |> arrange(desc(`%_ext`)) |>
  knitr::kable(digits = 3, align = "c", caption = "Specializations with the highest rate of graduates working outside of their region of graduation")
  
```

```{r}

insertion_master_panel |>
  filter(!is.na(`% emplois extérieurs à la région de l’université`)) |>
  group_by(Académie,Domaine) |>
  summarise(`%_ext` = mean(`% emplois extérieurs à la région de l’université`))|>
  slice(which.min(`%_ext`)) |>
    arrange(desc(`%_ext`)) |>
  knitr::kable(digits = 3, align = "c", caption = "Specializations with the lowest rate of graduates working outside of their region of graduation")
 
```

-   For the majority of "académies", the specialization with the lowest rate of graduates working outside of their region of graduation is education. It is interesting considering that new teachers typically do not choose where they work.

-   The two specializations where most students move out of their region of graduation are science/technology/health and literature/languages/arts.

-   For the regions of Guadeloupe and French Guyana, the lack of observations in our survey makes the results for these zones meaningless as only one specialization is represented.

-   The "académies" with the lowest rates of graduates leaving are Paris, Versailles and Créteil. A possible explanation is that these are the three "académies" of the Île-de-France region, the main economic center of the country. These graduates are more likely to find employment (or at least employment with the highest salaries) in their region of graduation.

### Q6: Do some specializations attract more women/scholarship students ?

```{r}
## Determining the rounded mean and standard deviation % of women in our survey
average_femme <- round(mean(insertion_master_panel$`% femmes`, na.rm = TRUE), 2)
stdev_femme <- round(sd(insertion_master_panel$`% femmes`, na.rm = TRUE),2)
```

In our survey, there is an average `r paste(average_femme)` % of women, with a standard deviation of `r paste(stdev_femme)`. We can notice that some specializations have a much higher proportion of women. Keeping only those with a proportion of women higher than the average, we obtain:

```{r}
#'[Creating a data frame with the mean % of women per discipline over the 11 years.] 
aggregate_femme <- aggregate_data |>
  filter(!is.na(`% femmes`)) |>
  group_by(Discipline) |>
  summarise(`Taux de femmes` = mean(`% femmes`))

#'[Keeping the discipline with a higher than average % of women]
aggregate_femme |>
  filter(`Taux de femmes` > average_femme) |>
  arrange(desc(`Taux de femmes`) ) |>
  mutate(`z-score` = round((`Taux de femmes` - average_femme)/stdev_femme,4)) |>
  knitr::kable(digits = 3, align = "c",
               caption = " Specializations with a higher than average proportion of women")

```

The z-score is the number of standard deviations between the observed value and the mean.

We can notice that the first-degree education and psychology specializations have a strong majority of women (a z-score of around 1.5).

The next specializations with the highest proportion of women, general teaching and literature, language and art, have a z-score of \~1, or a 0.5σ difference from the first two specializations.

Now, let's focus on the percentage of scholarship students in our survey.

```{r}
## Determining the rounded mean and standard deviation % of scholarship students in our survey
average_scholarship <- round(mean(insertion_master_panel$`% de diplômés boursiers`, na.rm = TRUE), 2)
stdev_scholarship <- round(sd(insertion_master_panel$`% de diplômés boursiers`, na.rm = TRUE),2)
```

## Conclusion

## Appendix

```{r}
#Regression result of Question 2
summary(regression_uni)
```
